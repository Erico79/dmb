<?php/*************************************************************************/define("GOOGLE_API_KEY","AIzaSyBkjSMGjY8IHrQuQHSfXk8SL4DhioNjCtg");function traceActivity($text)    {        date_default_timezone_set("Africa/Nairobi");        $today = time().":".date("Y-m-d H:i:s");        $myFile = "logs/".date("Y-m-d")."_api_posts.txt";        $fh = fopen($myFile,'a');        fwrite($fh, $today."==".$text."\n");        fclose($fh);    }function sanitizeVariable($var){    return $var = pg_escape_string(trim($var));}function checkForExistingEntry($tablename, $column_name, $id){  $check_query = "SELECT $column_name FROM $tablename WHERE $column_name = '".sanitizeVariable($id)."'";  $result = run_query($check_query);  $num_rows = get_num_rows($result);  if($num_rows >= 1){    return true;  }else{    return false;  }}/**************************************************************************DATABASE LAYER FUNCTIONS**************************************************************************/function run_query($query)	{		global $conn;		//$query = "database ori_ebppp; " .  $query;		$result = pg_query($conn,$query);		return $result;	}function run_query_host($conn,$query)    {        //global $conn;        //$query = "database ori_ebppp; " .  $query;        $result = pg_query($conn,$query);        return $result;    }function get_num_rows($result_set)	{		$result = pg_num_rows($result_set);		return $result;	}function get_row_data($result_set)	{		$result = pg_fetch_array($result_set);		return $result;	}/**************GET SERVICES*/ function getLiveItems(){	$messages = Array();    $query = "SELECT a.id, a.buy_now_option,i.item_name,a.refresh_rate,    	 	 a.reserve_price                 FROM auctions a LEFT JOIN items i                  ON a.item_id = i.id                WHERE a.status = '1'                ORDER by a.id DESC";	traceActivity($query);    $result = run_query($query);	traceActivity(json_encode($result));    while($row = get_row_data($result)){    	traceActivity("Inside 1");        if($row['buy_now_option']=="t")            $subject = 1;        else            $subject = 0;        $msg['auction_id'] = (int) $row['id'];        $msg['buy_now'] = $subject;        $msg['name'] = $row['item_name'];// $row['created'];        $msg['refresh_rate'] = $row['refresh_rate'];        $msg['reserve_price'] = $row['reserve_price'];        $msg['image_path'] = "https://www.windstream.com/uploadedImages/Content/Product/Electronics/Tablets_Laptops_and_Desktops/HP255Laptop-thumb.jpg";        $messages[] = $msg;           }    return $messages;}function creatAuctionBid($customer_id,$auction_id){	//create bid..        $query = "INSERT INTO auction_bids(mf_id,auction_id, bid_date, new_endtime,bid_price)                   VALUES('".$customer_id."','".$auction_id."','".date("Y-m-d H:i:s")."',                  '".date("Y-m-d H:i:s")."','0')                   RETURNING bid_id";        traceActivity($query);        $result = run_query($query);        $row = get_row_data($result);        $claim_id = $row['bid_id'];        return $claim_id;}function getLiveTime(){	$messages = Array();    $query = "SELECT a.id, a.buy_now_option,i.item_name,a.refresh_rate,    	 	 a.reserve_price                 FROM auctions a LEFT JOIN items i                  ON a.item_id = i.id                WHERE a.status = '1'                ORDER by a.id DESC";	traceActivity($query);    $result = run_query($query);	traceActivity(json_encode($result));    while($row = get_row_data($result)){    	traceActivity("Inside 1");        if($row['buy_now_option']=="t")            $subject = 1;        else            $subject = 0;        $msg['auction_id'] = (int) $row['id'];        $msg['end_time'] = rand(1,30);//$subject;        $msg['new_price'] = rand(10,50);//$row['item_name'];// $row['created'];        $messages[] = $msg;           }    return $messages;}function getBillingFileAmountByCustomerCode($account_code){    $query = "SELECT billing_amount            FROM customer_billing_file            WHERE customer_account_code = '".$account_code."'";    $result = run_query($query);    $row = get_row_data($result);    return $row['billing_amount'];}function getLoanRepayments($customer_id){    $messages = Array();    $query = "SELECT lr.*, cb.*                FROM loan_repayments lr LEFT JOIN customer_bills cb                 ON lr.bill_id = cb.bill_id                WHERE cb.mf_id = '".$customer_id."'                 ORDER by lr.repay_id DESC";    $result = run_query($query);    while($row = get_row_data($result)){        if($row['claim_airtime']=="t")            $subject = 1;        else            $subject = 0;        $msg['id'] = (int) $row['repay_id'];        $msg['claim_airtime'] = $subject;        $msg['date'] = $row['repayment_date'];// $row['created'];        $msg['account'] = $row['account_code'];        $msg['amount'] = $row['bill_amount_paid'];        $messages[] = $msg;           }    return $messages;}function airtimeAvailable($airtime_amount){    $data['voucher_pin'] = 0;    $query = "SELECT av.* FROM airtime_vouchers av LEFT JOIN airtime_denoms ad              ON av.voucher_denom = ad.id              WHERE ad.value = '".$airtime_amount."' AND av.voucher_status = FALSE";    traceActivity($query);    $result = run_query($query);    if(get_num_rows($result)){        $data = get_row_data($result);        return $data;    }    else        return $data;}function repayIdIsAvailable($repay_id){        $query = "SELECT * FROM loan_repayments              WHERE repay_id = ".$repay_id."              AND claim_airtime = FALSE";    traceActivity($query);    $result = run_query($query);    if(get_num_rows($result)){        return true;    }    else        return false;}function claimAirtime($customer_id,$account_code,$repay_id,$bill_id,$airtime_amount){        //Check if Airtime Available    $airtime_ready = airtimeAvailable($airtime_amount);    $customer_names = getCustomerNamesByMfId($customer_id);    if($airtime_ready['voucher_pin']){        //Update payment as credit awarded        $query = "UPDATE loan_repayments SET claim_airtime = true                    WHERE repay_id = '".$repay_id."'";        traceActivity($query);        $result = run_query($query);        $serial = $airtime_ready['voucher_serial'];        $pin = $airtime_ready['voucher_pin'];                //create airtime award claim record...        $query = "INSERT INTO airtime_claim(airtime_amount,airtime_serial_no, claimed,airtime_claimed_date,customer_account_id,bill_id,repay_id)                  VALUES('".$airtime_amount."','".$serial."',TRUE,'".date("Y-m-d H:i:s")."','".getCustomerAccountIdByCustomerCode($account_code)."','".$bill_id."','".$repay_id."')                   RETURNING airtime_claim_id ";        traceActivity($query);        $result = run_query($query);        $row = get_row_data($result);        $claim_id = $row['airtime_claim_id'];        //update airtime voucher as taken/consumed        $query = "update airtime_vouchers set voucher_status=TRUE, voucher_claim_id=".$claim_id." WHERE voucher_serial like '".$serial."'";        traceActivity($query);        run_query($query);        //Send Message notification        $subject = "Airtime Claim#".$claim_id." For Loan#".$repay_id;        $message = "Dear ".$customer_names.",".                   "\n\nThanks for your successful loan repayment and Airtime Claim.You have been awarded Airtime worth Ksh.".number_format($airtime_amount,2).                   "\n\nHere is your Airtime Serial and Voucher PIN".                   "\n\n\tSerial: ".$serial."".                   "\n\tPIN: ".$pin."".                   "\n\nIts our honor to serve you!\n\nGTEL Care";        $message_id = createInboxMessage($customer_id,$subject,$message);        $msg['type'] ="inbox";        $msg['id'] = (int) $message_id;        $msg['subject'] = $subject;        $msg['date'] = date("Y-m-d H:i:s");// $row['created'];        $msg['content'] = $message;        $msg['more_link'] = "http://www.obulexsolutions.com";        $gcm_id = getGcmIdByMfId($customer_id,$account_code);        send_notification($gcm_id, $msg);        return $pin;    }    else    {        //Send Message notification        $subject = "FAILED Airtime Claim Loan#".$repay_id;        $message = "Dear ".$customer_names.",".                   "\n\nThanks for your successful loan repayment and Airtime Claim.\nSorry we could not process your airtime claim at this moment!".                   "\nPlease wait 30 minutes and try agian...".                                      "\n\nIts our honor to serve you!";        $message_id = createInboxMessage($customer_id,$subject,$message);        $msg['type'] ="inbox";        $msg['id'] = (int) $message_id;        $msg['subject'] = $subject;        $msg['date'] = date("Y-m-d H:i:s");// $row['created'];        $msg['content'] = $message;        $msg['more_link'] = "http://www.obulexsolutions.com";        $gcm_id = getGcmIdByMfId($customer_id,$account_code);        send_notification($gcm_id, $msg);        return false;    }}function buyAirtime($customer_id,$account_code,$airtime_amount){        //Check if Airtime Available    $airtime_ready = airtimeAvailable($airtime_amount);    $customer_names = getCustomerNamesByMfId($customer_id);    if($airtime_ready['voucher_pin']){        $serial = $airtime_ready['voucher_serial'];        $pin = $airtime_ready['voucher_pin'];        /***************Gpay Wallet Queries*******************/        //Update balance        $query = "UPDATE customer_file SET balance = (balance-$airtime_amount) WHERE mf_id = '".$customer_id."'";        traceActivity($query);        $result = run_query($query);                        //create transaction...        $query = "INSERT INTO gpay_transactions(transaction_amount,transaction_type, status, transaction_date, transaction_mf_id)                  VALUES('".$airtime_amount."','1',TRUE,'".date("Y-m-d H:i:s")."','".$customer_id."')                   RETURNING transaction_id ";        traceActivity($query);        $result = run_query($query);        $row = get_row_data($result);        $transaction_id = $row['transaction_id'];        //create journal        $query = "INSERT INTO wallet_journal(amount,dr_cr, journal_type, particulars, journal_date, stamp,mf_id)                  VALUES('".$airtime_amount."','DR',1,'Airtime Purchase - ".$transaction_id."','".date("Y-m-d H:i:s")."','".time()."','".$customer_id."')                   RETURNING journal_id ";        traceActivity($query);        run_query($query);        /***********UPDATE VOUCHER*****************************/        //update airtime voucher as taken/consumed        $query = "update airtime_vouchers set voucher_status=TRUE, voucher_claim_id=".$claim_id." WHERE voucher_serial like '".$serial."'";        traceActivity($query);        run_query($query);        //Send Message notification        $subject = "Airtime Purchase#".$transaction_id;        $message = "Dear ".$customer_names.",".                   "\n\nThanks for your successful purchase of Airtime.You have received Airtime worth Ksh.".number_format($airtime_amount,2).                   "\n\nHere is your Airtime Serial and Voucher PIN".                   "\n\n\tSerial: ".$serial."".                   "\n\tPIN: ".$pin."".                   "\n\nIts our honor to serve you!\n\nGTEL Care";        $message_id = createInboxMessage($customer_id,$subject,$message);        $msg['type'] ="inbox";        $msg['id'] = (int) $message_id;        $msg['subject'] = $subject;        $msg['date'] = date("Y-m-d H:i:s");// $row['created'];        $msg['content'] = $message;        $msg['more_link'] = "http://www.obulexsolutions.com";        $gcm_id = getGcmIdByMfId($customer_id,$account_code);        send_notification($gcm_id, $msg);        return $pin;    }    else    {        traceActivity("Send Fail message...");        //Send Message notification        $subject = "FAILED Airtime Purchase";        $message = "Dear ".$customer_names.",".                   "\n\nSorry we could not process your airtime purchase at this moment!".                   "\nPlease wait 30 minutes and try agian...".                                      "\n\nIts our honor to serve you!";        $message_id = createInboxMessage($customer_id,$subject,$message);        $msg['type'] ="inbox";        $msg['id'] = (int) $message_id;        $msg['subject'] = $subject;        $msg['date'] = date("Y-m-d H:i:s");// $row['created'];        $msg['content'] = $message;        $msg['more_link'] = "http://www.obulexsolutions.com";        $gcm_id = getGcmIdByMfId($customer_id,$account_code);        send_notification($gcm_id, $msg);        return false;    }}function getNewMessages($customer_id){    $messages = Array();    $query = "SELECT cm.*, m.*                FROM customer_messages cm LEFT JOIN message m                 ON cm.message_id = m.message_id LEFT JOIN customer_account ca                ON cm.customer_account_id = ca.customer_account_id                WHERE ca.mf_id = '".$customer_id."'                 ORDER by cm.message_id DESC";    $result = run_query($query);    while($row = get_row_data($result)){        if($row['subject'] == "")            $subject = "No Subject";        else            $subject = $row['subject'];        if($row['body'] == "")            $body = "No Message";        else            $body = $row['body'];        $msg['id'] = (int) $row['message_id'];        $msg['subject'] = $subject;        $msg['date'] = date("Y-m-d H:i:s");// $row['created'];        $msg['content'] = $body;        $msg['more_link'] = "http://www.obulexsolutions.com";        $messages[] = $msg;           }    return $messages;}function sendSupportNotificationToAdmins($ticket_id,$customer_id,$subject,$customer_names,$message){    $query = "SELECT *              FROM user_login2               WHERE user_role = '1'";    $result = run_query($query);    $count = 1;    while($row = get_row_data($result)){                if($count == 1)            $recipients = $row['mf_id'];        else            $recipients .= ",".$row['mf_id'];        $count++;    }       $final_message =    "Dear Admin,".                        "\n\nA new support ticket number ".$ticket_id." has been received from ".$customer_names. ".\n\n";    $final_message .=   "Ticket Message:\n";    $final_message .=   $message;    $final_message .=   "\n\nYours Truly,\n\nGTEL Care";    $query = "INSERT INTO message (body,subject,sender,recipients,message_type_id,status)              VALUES('".$final_message."','".$subject."','".$customer_id."','{".$recipients."}','{3}',0) RETURNING message_id ";    traceActivity($query);    $result = run_query($query);    $row = get_row_data($result);        $message_id = $row['message_id'];        return $message_id;}function sendClaimNotificationToAdmins($ticket_id,$customer_id,$subject,$customer_names,$message){    $query = "SELECT *              FROM user_login2               WHERE user_role = '1'";    $result = run_query($query);    $count = 1;    while($row = get_row_data($result)){                if($count == 1)            $recipients = $row['mf_id'];        else            $recipients .= ",".$row['mf_id'];        $count++;    }       $final_message =    "Dear Admin,".                        "\n\nA new Insurance claim number ".$ticket_id." has been received from ".$customer_names. ".\n\n";    $final_message .=   "Claim Message:\n";    $final_message .=   $message;    $final_message .=   "\n\nYours Truly,\n\nGTEL Care";    $query = "INSERT INTO message (body,subject,sender,recipients,message_type_id,status)              VALUES('".$final_message."','".$subject."','".$customer_id."','{".$recipients."}','{3}',0) RETURNING message_id ";    traceActivity($query);    $result = run_query($query);    $row = get_row_data($result);        $message_id = $row['message_id'];        return $message_id;}function sendSupportNotificationToAssignedStaff($ticket_id,$customer_id,$subject,$customer_names,$message){    $query = "SELECT *              FROM support_ticket_assignment               WHERE support_ticket_id = '".$ticket_id."'";    $result = run_query($query);        $row = get_row_data($result);              $assigned_staff = $row['assigned_to'];        $final_message =    "Dear Staff,".                        "\n\nThere is a new customer response to ticket number ".$ticket_id." from ".$customer_names. ".\n\n";    $final_message .=   "Ticket Reply Message:\n";    $final_message .=   $message;    $final_message .=   "\n\nYours Truly,\n\nGTEL Care";    $query = "INSERT INTO message (body,subject,sender,recipients,message_type_id,status)              VALUES('".$final_message."','".$subject."','".$customer_id."','{".$assigned_staff."}','{3}',0) RETURNING message_id ";    traceActivity($query);    $result = run_query($query);    $row = get_row_data($result);        $message_id = $row['message_id'];        return $message_id;}function getInsuranceData($customer_id,$account_code){    $rows = array();    $customer_account_id = getCustomerAccountIdByCustomerCode($account_code);    $query = "SELECT * FROM gtel_insurance               where customer_account_id='".$customer_account_id."'              AND status = TRUE";    $result = run_query($query);    if(get_num_rows($result)){        $rows = get_row_data($result);    }else{        $rows['insurance_id'] = 0;    }    return $rows;}/******************************************************************************/function createInsuranceClaim($customer_id,$account_code,$policy_number,$message){    $status = TRUE;    $customer_account_id = getCustomerAccountIdByMfId($customer_id);        $query = "INSERT INTO customer_insurance_claim (insurance_id,claim_type,case_type,status,claim_date,description,claim_mf_id)              VALUES('".$policy_number."','Repair','First fix','".$status."','".date("Y-m-d")."','".$message."','".$customer_id."')               RETURNING claim_id ";    traceActivity($query);    $result = run_query($query);    $row = get_row_data($result);        $ticket_id = $row['claim_id'];    return $ticket_id;}function getInsuranceClaims($customer_id,$account_code,$policy_number){    $status = TRUE;    $customer_account_id = getCustomerAccountIdByMfId($customer_id);        $query = "SELECT * FROM customer_insurance_claim               WHERE insurance_id = '".$policy_number."'";    traceActivity($query);    $result = run_query($query);    while($row = get_row_data($result)){        $msg['claim_id'] =      $row['claim_id'];        $msg['date'] =         $row['claim_date'];        $msg['particulars'] =  $row['description'];        $msg['status'] = "Closed";        $messages[] = $msg;    }        //$ticket_id = $row['claim_id'];    return $messages;}function getInsuranceTypeByImei($imei){    //$status = TRUE;            $query = "SELECT gdm.service_id FROM gtel_device gd LEFT JOIN gtel_device_model gdm               ON gd.device_model_id = gdm.device_model_id              WHERE gd.imei = '".$imei."'";    traceActivity($query);    $result = run_query($query);    $row = get_row_data($result);    $service_id = $row['service_id'];        //$ticket_id = $row['claim_id'];    $array['name'] = getServiceNameByID($service_id);    $array['price'] = getServiceAmountByID($service_id);    return $array;}function getServiceNameByID($service_id){    $status = TRUE;            $query = "SELECT service_option FROM service_channels               WHERE service_channel_id = '".$service_id."'";    traceActivity($query);    $result = run_query($query);    $row = get_row_data($result);    $service_id = $row['service_option'];        //$ticket_id = $row['claim_id'];    return $service_id;}function getServiceAmountByID($service_id){    $status = TRUE;            $query = "SELECT price FROM service_channels               WHERE service_channel_id = '".$service_id."'";    traceActivity($query);    $result = run_query($query);    $row = get_row_data($result);    $service_id = $row['price'];        //$ticket_id = $row['claim_id'];    return $service_id;}function createSupportTicket($customer_id,$subject,$message){    $messages = Array();    $status = 0;    $customer_account_id = getCustomerAccountIdByMfId($customer_id);        $query = "INSERT INTO support_ticket (customer_account_id,subject,reported_by,status,body)              VALUES('".$customer_account_id."','".$subject."','".$customer_id."','".$status."','".$message."') RETURNING support_ticket_id ";    traceActivity($query);    $result = run_query($query);    $row = get_row_data($result);        $ticket_id = $row['support_ticket_id'];    $message_id = createInboxMessage($customer_id,$subject,$message);    $query = "INSERT INTO support_tickets_messages (support_ticket_id,message_id)              VALUES('".$ticket_id."','".$message_id."')";    traceActivity($query);    $result = run_query($query);    return $ticket_id;}function createFriendReferral($customer_id,$names,$idno,$phone){    $messages = Array();    $status = 0;    $customer_account_id = getCustomerAccountIdByMfId($customer_id);    $query = "INSERT INTO referrals (referral_phone_number,referral_id_no,referral_names,referral_date,referee_mf_id)              VALUES('".$phone."','".$idno."','".$names."','".date("Y-m-d H:i:s")."','".$customer_id."') RETURNING referrals_id ";    traceActivity($query);    $result = run_query($query);    $row = get_row_data($result);    return $row['referrals_id'];}function createInboxMessage($customer_id,$subject,$message){    $messages = Array();    $status = 0;    $customer_account_id = getCustomerAccountIdByMfId($customer_id);    $query = "INSERT INTO message (body,subject,sender,recipients,message_type_id,status)              VALUES('".$message."','".$subject."','".$customer_id."','{".$customer_account_id."}','{1}',0) RETURNING message_id ";    traceActivity($query);    $result = run_query($query);    $row = get_row_data($result);        $message_id = $row['message_id'];    $query = "INSERT INTO customer_messages (customer_account_id, message_id)              VALUES('".$customer_account_id."','".$message_id."')";    run_query($query);    return $message_id;}function createTicketComment($customer_id,$ticket_id,$comment){    $subject = "Customer Reply - Ticket#".$ticket_id;    $query = "INSERT INTO message (body,subject,sender,recipients,message_type_id)              VALUES('".$comment."','".$subject."','".$customer_id."','{".$customer_id."}','{1}') RETURNING message_id ";    $result = run_query($query);    $row = get_row_data($result);        $message_id = $row['message_id'];    $query = "INSERT INTO support_tickets_messages (support_ticket_id, message_id)              VALUES('".$ticket_id."','".$message_id."')";    run_query($query);    return $message_id;    }/**************************************************************************/function checkLogin($phone,$imei,$gcm_id){    $query = "SELECT ca.*, m.*            FROM masterfile m LEFT JOIN customer_account ca            ON m.mf_id = ca.mf_id LEFT JOIN gtel_device gd            ON ca.device_id = gd.device_id            WHERE gd.imei = '".$imei."' ";    //traceActivity($query);    $result = run_query($query);    $num = get_num_rows($result);    $array = get_row_data($result);   if($num > 0)    {        $data['firstname']      = $array['firstname'];        $data['surname']        = $array['surname'];        $data['id_passport']    = $array['id_passport'];        $data['image']          = $array['images_path'];        $data['customer_id']    = $array['mf_id'];        $data['customer_phone'] = $array['issued_phone_number'];        $data['account_code']    = $array['customer_code'];        //Update GCM ID        $query_gcm = "UPDATE customer_account set gcm_id='".$gcm_id."'                       WHERE customer_code='".$array['customer_code']."'";        run_query($query_gcm);                return $data;    }    else //login has failed    {                return  0;             }}/**************************************************************************/function getGPayBalance($mf_id){     $query =   "SELECT balance FROM customer_file cf                 WHERE cf.mf_id = '".$mf_id."' ";    $result = run_query($query);    $row = get_row_data($result);    if(!isset($row['balance']))        $balance = 0;    else        $balance = $row['balance'];    return $balance;}function getGPayJournals($mf_id){    $messages = Array();    $query = "SELECT *                FROM wallet_journal                WHERE mf_id = '".$mf_id."'                 ORDER by journal_id DESC";    $result = run_query($query);    while($row = get_row_data($result)){        if($row['particulars'] == "")            $subject = "No Particulars";        else            $subject = $row['particulars'];        $msg['journal_id'] = (int) $row['journal_id'];        $msg['particulars'] = $subject;        $msg['date'] = $row['journal_date'];// $row['created'];        $msg['drcr'] = $row['dr_cr'];        $msg['amount'] =$row['amount'];        $messages[] = $msg;           }    return $messages;}/**************************************************************************/function getCustomerNamesByMfId($mf_id){     $query =   "SELECT surname, firstname FROM masterfile                 WHERE mf_id = '".$mf_id."' ";    $result = run_query($query);    $row = get_row_data($result);    return $row['firstname'] . " " .$row['surname'];}//Fundamentally wrong... customer can have many customer_account_idSfunction getCustomerAccountIdByMfId($mf_id){     $query =   "SELECT customer_account_id FROM customer_account ca                 WHERE ca.mf_id = '".$mf_id."' ";    $result = run_query($query);    $row = get_row_data($result);    return $row['customer_account_id'];}function getCustomerAccountIdByCustomerCode($code){     $query =   "SELECT customer_account_id FROM customer_account ca                 WHERE ca.customer_code = '".$code."' ";    $result = run_query($query);    $row = get_row_data($result);    return $row['customer_account_id'];}function getMfIdByCustomerAccountId($account_id){     $query =   "SELECT mf_id FROM customer_account ca                 WHERE ca.customer_account_id = '".$account_id."' ";    $result = run_query($query);    $row = get_row_data($result);    return $row['mf_id'];}function getMfIdByCustomerCode($code){     $query =   "SELECT mf_id FROM customer_account ca                 WHERE ca.customer_code = '".$code."' ";    $result = run_query($query);    $row = get_row_data($result);    return $row['mf_id'];}function getCustomerCodeByCustomerAccountId($account_id){    $query =   "SELECT customer_code FROM customer_account ca                WHERE ca.customer_account_id = '".$account_id."' ";    $result = run_query($query);    $row = get_row_data($result);    return $row['customer_code'];}function getCustomerCodeByMfId($mf_id){     $query =   "SELECT customer_code FROM customer_account ca                 WHERE ca.mf_id = '".$mf_id."' ";    $result = run_query($query);    $row = get_row_data($result);    return $row['customer_code'];}function getGcmIdByMfId($mf_id,$account_code){     $query =   "SELECT gcm_id FROM customer_account ca                 WHERE ca.mf_id = '".$mf_id."'                  AND customer_code = '".$account_code."'";    traceActivity($query);    $result = run_query($query);    $row = get_row_data($result);    return $row['gcm_id'];}function getImeiIdByAccountCode($account_code){    $query =   "SELECT imei FROM gtel_device gd                LEFT JOIN customer_account ca ON gd.device_id = ca.device_id                WHERE ca.customer_code = '".$account_code."'";    traceActivity($query);    $result = run_query($query);    $row = get_row_data($result);    return $row['imei'];}function getBillIdByRepayId($repay_id){     $query =   "SELECT bill_id FROM loan_repayments                 WHERE repay_id = '".$repay_id."' ";    $result = run_query($query);    $row = get_row_data($result);    return $row['bill_id'];}/**************************************************************************/	function formatMoney($number, $fractional=false) {	if ($fractional) 	{		$number = sprintf('%.2f', $number);	}	while (true) 	{		$replaced = preg_replace('/(-?\d+)(\d\d\d)/', '$1,$2', $number);		if ($replaced != $number) {			$number = $replaced;		} else {			break;		}	}	return $number;} function show_action_message($message){	$content = "<div style='background-color:#E6E6E6; height:50px;'>										<div style='float:left;padding:1px;'>						<img align='left' src='done.png' width='45' height='47' />					</div>        					<div align='left' style='float:left; margin-left:5px; 											 padding-top:20px; color: #F28914; font-weight: bold; font-size: 14px;'>						".$message."					</div>    			</div>";		echo $content;}function getnextID($table, $col, $default) {	 $fit = "SELECT max($col) as amax FROM $table";	 $fitter = run_query($fit);     $mobett = get_row_data($fitter);	 $top = $mobett['amax']; 	 if($top == "")	 	$thenum = $default;	else		$thenum = ($top + 1); 	 return $thenum;  }	function getnextCode($table, $col, $cond1, $cond2, $default) {	 $fit = "SELECT max($col) as amax FROM $table where $cond1 like '$cond2'";	 $fitter = run_query($fit);     $mobett = get_row_data($fitter);	 $top = $mobett['amax']; 	 if($top == "")	 	$thenum = $default;	else		$thenum = ($top + 1); 	 return $thenum;  }	function logActivity($user,$activity,$module)	{		date_default_timezone_set('Africa/Nairobi');		$today = date("Y-m-d");		$now = time()."*".date('H:i:s');			$fit = "INSERT INTO ori_ebppp.activitylog (userid,module,activity,date,time)				VALUES ('$user','$module','$activity','$today','$now')";		run_query($fit);		 	}	function ShortenText($text, $size="100") 		 {			// Change to the number of characters you want to display			$chars = $size;			$text = $text." ";			$text = substr($text,0,$chars);			$text = substr($text,0,strrpos($text,' '));			$text = $text."...";			return $text;		 }	/*function to get a system setting from the settings table*/	function getAPISetting($item)	{		$sql = "select setting from tbl_settings where item like '$item'";		$result = run_query($sql);		$arr = get_row_data($result);		return $arr['setting'];	}	/*function to update a setting on the settings table*/	function updateAPISetting($item, $setting)	{		$sql = "update tbl_settings set setting = '$setting' where item like '$item'";		$result = run_query($sql);	}		/*function to add a notice*/	function addAPINotice($title,$notice)	{		$today = date("Y-m-d");		$sql = "insert into tbl_notices (title,notice,creation_date) values('$title','$notice','$today')";		$result = run_query($sql);	}/*********************************************************************************************/function getTransactionTypeName($one){	$query = "SELECT title FROM ori_ebppp.transaction_types WHERE id = '$one'";	$data = run_query($query);	$rows = get_row_data($data);	$name = trim($rows['title']);		return $name;}function number_words($number) {     if (($number < 0) || ($number > 9999999999))     {     throw new Exception("Number is out of range");    }     $Bn = floor($number / 1000000000);  /* Millions (giga) */ 	$number -= $Bn * 1000000000; 	$Gn = floor($number / 1000000);  /* Millions (giga) */     $number -= $Gn * 1000000;     $kn = floor($number / 1000);     /* Thousands (kilo) */     $number -= $kn * 1000;     $Hn = floor($number / 100);      /* Hundreds (hecto) */     $number -= $Hn * 100;     $Dn = floor($number / 10);       /* Tens (deca) */     $n = $number % 10;               /* Ones */     $res = "";     if ($Bn)     {         $res .= number_words($Bn) . " Billion, ";     } 		if ($Gn)     {         $res .= number_words($Gn) . " Million, ";     }     if ($kn)     {         $res .= (empty($res) ? "" : " ") .             number_words($kn) . " Thousand";     }     if ($Hn)     {         $res .= (empty($res) ? "" : " ") .             number_words($Hn) . " Hundred";     }     $ones = array("", "One", "Two", "Three", "Four", "Five", "Six","Seven", "Eight", "Nine", "Ten", "Eleven", "Twelve", "Thirteen",         "Fourteen", "Fifteen", "Sixteen", "Seventeen", "Eighteen","Nineteen");     $tens = array("", "", "Twenty", "Thirty", "Fourty", "Fifty", "Sixty","Seventy", "Eighty", "Ninety");     if ($Dn || $n)     {         if (!empty($res))         {             $res .= " and ";         }         if ($Dn < 2)         {             $res .= $ones[$Dn * 10 + $n];         }         else         {             $res .= $tens[$Dn];             if ($n)             {                 $res .= "-" . $ones[$n];             }         }     }     if (empty($res))     {         $res = "zero";     }     return $res; } // formats date from sql representation to dd-mm-yyyy function formatDate($date){	$rec = explode("-",$date);	$newd = ($rec[2].'-'.$rec[1].'-'.$rec[0]);	return $newd;}// formatting the output of a string function formatStr($passed){	$newstr = "";	$arr = explode(" ",$passed);	foreach($arr as $pass)	{		if($pass != '') // if not a null string ....		{			$ind = (strlen($pass) - 1); // the length of the string .......			$first = strtoupper(substr($pass,0,1)); // the first letter 			$rem = strtolower(substr($pass,1,$ind)); // the remaining part of the string  			$comm = ($first.$rem);			$newstr.=($comm." "); // join up the string .......					}	} // end of the loop .....	return $newstr; // the new string ........ } // end of the function .......function WriteContactsXML(){    $myFile = "contacts_list.xml";    $fh = fopen($myFile,'w');				$dataline ="<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?>\n\n<contacts>\n";				fwrite($fh,$dataline); 				$all_prods = run_query("Select firstname,middlename,lastname,user_id,adm_no from tbl_studlist Order By firstname ASC");										while($array = get_row_data($all_prods))	{		$name = $array['firstname'] . " " . $array['middlename'];		$lastname = $array['lastname'];		$all_names = $name . " " . $lastname; 				$code = $array['adm_no'];		$dataline = "<contact>\n".						"<name>" . $name . "</name>\n" .						"<number>" . $lastname . "</number>\n" .						"<code>" . $code . "</code>\n" .						"<string>" . $code . " ".$all_names."</string>\n" .					"</contact>\n";		fwrite($fh,$dataline); 	}				fwrite($fh,"</contacts>");	       fclose($fh);}function postToHttpJsonAPI($url,$fields){    //url-ify the data for the POST    foreach($fields as $key=>$value) { $fields_string .= $key.'='.$value.'&'; }    rtrim($fields_string, '&');   // print_r($fields_string);    //open connection    $ch = curl_init();    //set the url, number of POST vars, POST data    curl_setopt($ch,CURLOPT_URL, $url);    curl_setopt($ch,CURLOPT_POST, count($fields));    curl_setopt($ch,CURLOPT_POSTFIELDS, $fields_string);    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);    //execute post    $result = curl_exec($ch);    //echo $result;//returns 1 if successfull    //close connection    //$json2 = json_decode($result, true);    // Now get membership ID.    //echo $json['member_id'];    curl_close($ch);    return $result;}function createMessage($data = array('sender' => '', 'recipient' => '', 	'message_type' => '', 'message' => '','subject' => '','recipients_are_phone_nos' => FALSE, 'recipients_are_email' => FALSE)){    $messages = Array();    $status = 0;    $recipients_are_email = (is_null($data['recipients_are_email']) or empty($data['recipients_are_email'])) ? 0 : $data['recipients_are_email'];    $recipients_are_phone_nos = (is_null($data['recipients_are_phone_nos']) or empty($data['recipients_are_phone_nos'])) ? 0 : $data['recipients_are_phone_nos'];    //$customer_account_id = getCustomerAccountIdByMfId($data['recipient']);    $query = "INSERT INTO message (body,subject,sender,recipients,message_type_id,status,recipients_are_phone_nos,recipients_are_email) ".             "VALUES('".$data['message']."','".$data['subject']."','".$data['sender']."','{".	     $data['recipient']."}','{".$data['message_type']."}',0,'".$recipients_are_phone_nos."','".$recipients_are_email."') ".	     "RETURNING message_id ";    traceActivity($query);    $result = run_query($query);    $row = get_row_data($result);        $message_id = $row['message_id'];    return $message_id;}   function SendSMS($phone,$message)   {	$username = "niamoja";	$password = "Test1234";	$auth = base64_encode($username.":".$password);	$code = substr($phone,0,1);                    if($code == "0")                        $phone = "254".substr($phone,1);	$fields['from'] = "VOOMSMS";	$fields['to']   = $phone;	$fields['text'] = $message;	$json = json_encode($fields);	//$string_arr = "from=infobip&to=254720810193&text=Testing our sms system...";	$string_arr = $json;	$url = "https://api.infobip.com/sms/1/text/single";	$path = $url;	$host = "api.infobip.com";	$fp = fsockopen($host, 80);	// send the request headers:	fputs($fp, "POST $path HTTP/1.1\r\n");	fputs($fp, "Host: $host\r\n");	//fputs($fp, "Referer: $referer\r\n");	fputs($fp, "Authorization: Basic ".$auth." \r\n");	fputs($fp, "Content-Type: application/json\r\n");	fputs($fp, "Content-length: ". strlen($string_arr) ."\r\n");	fputs($fp, "Connection: close\r\n\r\n");	fputs($fp, $string_arr);	$result = ''; 	while(!feof($fp)) {    		// receive the results of the request    		$result .= fgets($fp, 128);	}	//print_r($result);	// close the socket connection:	fclose($fp);   }		/***********************************************************************///GOOGLE PUSH NOTIFICATIONfunction sendAndroidNotification($customer_id,$note){       //echo "rrr====".$customer_id."=====";         $query = "SELECT * FROM ndovu_android_devices WHERE customer_id = '".$customer_id."' ";      $data=run_query($query);      $status = 0;      //echo $query;            while($rows=get_row_data($data))      {          $message = Array();          $device = array($rows['gcm_id']);          $message = array("count" => $note,"customer_id"=>$customer_id);         // print_r($message);          traceRestActivity("P-NOTIFICATION: Message(".$message.") to Device(".$device.")");          send_notification($device, $message);               $status = 1;      }            return $status;}function send_notification($gcm_id, $message){        // include config        //include_once './config.php';                // Set POST variables        $url = 'https://gcm-http.googleapis.com/gcm/send';        $fields = array(            'to' => $gcm_id,            'data' => $message,        );        $mss = json_encode($fields);        traceActivity("GCM Message Trace: ".$mss);        //print_r($mss);        $headers = array(            'Authorization: key=' . GOOGLE_API_KEY,            'Content-Type: application/json'        );                //CURL Open connection        $ch = curl_init();        // Set the url, number of POST vars, POST data        curl_setopt($ch, CURLOPT_URL, $url);        curl_setopt($ch, CURLOPT_POST, true);        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);        // Disabling SSL Certificate support temporarly        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($fields));        // Execute post        $result = curl_exec($ch);        if ($result === FALSE) {            die('Curl failed: ' . curl_error($ch));        }        //print_r($result);        traceActivity("GCM Result Trace: ".$result);        // Close connection        curl_close($ch);        //echo $result; }?>